<!DOCTYPE html>
<html lang="zh-Hans">

<head>
  <meta charset="UTF-8" name="viewport" content="width=device-width" />
  <title>方块字标志牌生成器 | UTF-Block Sign Art Generator</title>
</head>

<body>
  <h1>方块字标志牌生成器<br />UTF-Block Sign Art Generator</h1>
  <label id="inputWrapper">
    输入文字 Input text：
    <textarea type="text" class="autoWidth">←换乘 1 号线&#10;←To Line 1</textarea>
  </label>
  <div>
    配置 Config：
    <div id="configWrapper" class="autoWidth">
      <div>
        标志牌类型 Sign type：
        <label>
          <input type="radio" class="signType" name="signType" value="sign" checked />
          <img src="sign.webp" alt="Sign" />
        </label>
        <label>
          <input type="radio" class="signType" name="signType" value="hangingSign" />
          <img src="hanging-sign.webp" alt="Hanging sign" />
        </label>
      </div>
      <div id="customChar">
        <div id="customCharButtons">自定义字符 Custom characters：
          <button type="button" onclick="setCustomChar(customChars['1.19']);">1.0~1.19.4</button>
          <button type="button" onclick="setCustomChar(customChars['1.20']);">1.20.1+</button>
        </div>
        <div id="customCharWrapper">
        </div>
        <template id="customCharTemplate">
          <label>
            <code></code>：
            <input name="customChar" value="" />
          </label>
        </template>
      </div>
    </div>
  </div>
  <button type="button" onclick="main()">绘制 Draw</button>
  <div id="canvasWrapper"></div>
  <div id="signsWrapper"></div>
</body>

<script>
  const customChars = {
    "1.19": ["  ", " ▗", "▖ ", "▄", " ▝", " ▐", "▞", "▟", "▘ ", "▚", "▌ ", "▙", "▀", "▜", "▛", "█"],
    "1.20": ["  ", " ▄", "▄ ", "▄▄", " ▀", " █", "▄▀", "▄█", "▀ ", "▀▄", "█ ", "█▄", "▀▀", "▀█", "█▀", "██"],
  }
  let customChar;
  setCustomChar(customChars["1.20"]);

  function setCustomChar(customChar) {
    const customCharWrapper = document.querySelector("#customCharWrapper");
    const customCharTemplate = document.querySelector("#customCharTemplate");
    customCharWrapper.innerHTML = "";
    customChar.forEach((char, index) => {
      const charName = index.toString(2).padStart(4, "0");
      const dom = customCharTemplate.content.cloneNode(true);
      dom.querySelector("code").textContent = `0b${charName}`;
      const dom_input = dom.querySelector("input");
      dom_input.id = `customChar_0b${charName}`;
      dom_input.value = char;
      customCharWrapper.appendChild(dom);
    });
  }

  function getCustomChar() {
    const inputs = document.querySelectorAll("#customCharWrapper input[name='customChar']");
    const result = [];
    inputs.forEach(input => {
      result.push(input.value);
    });
    return result;
  }
</script>

<script>
  function main() {
    const inputText = (document.fonts.check("8px 'Chill Bitmap 7px'")) ? (document.querySelector("#inputWrapper > textarea").value) : "字体加载中... Font loading...";
    const isHangingSign = document.querySelector(".signType:checked").value == "hangingSign";
    customChar = getCustomChar();

    const canvases = text2canvases(inputText, isHangingSign);
    const signs = canvases2signs(canvases);

    const signsWrapper = document.querySelector("#signsWrapper");
    const canvasWrapper = document.querySelector("#canvasWrapper");

    renderCanvases(canvases, canvasWrapper);
    renderSigns(signs, signsWrapper);
  }

  function text2canvases(text, isHangingSign) {
    let canvases = [];
    let textArray = Array.from(text);
    while (textArray.length) { // 逐字绘制
      let canvas = newCanvas(isHangingSign);
      let ctx = canvas.getContext("2d");
      let widthUsed = 0;
      do { // 判断剩余空间足够再绘制
        let Char = textArray.shift();
        ctx.fillText(Char, widthUsed, canvas.height - 1);
        widthUsed += ctx.measureText(Char).width;
        widthCharNext = ctx.measureText(textArray[0]).width;
      } while (widthUsed + widthCharNext <= canvas.width);
      canvases.push(canvas);
    }
    return canvases;

    function newCanvas(isHangingSign) {
      let canvas = document.createElement("canvas");
      canvas.className = "previewCanvas";
      canvas.height = 8;
      canvas.width = isHangingSign ? 12 : 20;
      let ctx = canvas.getContext("2d");
      ctx.fillStyle = "#fff";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#000";
      ctx.font = "8px 'Chill Bitmap 7px'";
      return canvas;
    }
  }

  function canvases2signs(canvases) {
    let signs = [];

    canvases.forEach(canvas => {
      let canvasData = Array.from(new Array(canvas.height), () => new Array(canvas.width)); // 空二维数组
      let sign = Array.from(new Array(canvas.height / 2), () => new Array(canvas.width / 2));

      let ctx = canvas.getContext("2d");
      let imgData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

      for (let y = 0; y < canvas.height; y++) {
        for (let x = 0; x < canvas.width; x++) { // 遍历像素
          let i = (y * canvas.width + x) * 4;
          const R = imgData[i];
          const G = imgData[i + 1];
          const B = imgData[i + 2];
          let pixel = ((R + G + B) / 3 < 127) ? 1 : 0; // 二值化

          canvasData[y][x] = pixel;
          if (y % 2 && x % 2) { // 像素4合1，生成UTF-8块元素
            let p1 = canvasData[y - 1][x - 1],
              p2 = canvasData[y - 1][x],
              p3 = canvasData[y][x - 1];
            sign[(y - 1) / 2][(x - 1) / 2] = customChar[(p1 << 3) | (p2 << 2) | (p3 << 1) | pixel];
          }
        }
      }
      sign = sign.map(e => e.join(""));
      signs.push(sign);
    });
    return signs;
  }

  function renderCanvases(canvases, wrapper) {
    wrapper.innerHTML = "";
    canvases.forEach(canvas => {
      wrapper.appendChild(canvas);
    });
  }

  function renderSigns(signs, wrapper) {
    wrapper.innerHTML = "";
    signs.forEach(sign => {
      let signElement = document.createElement("div");
      signElement.className = "sign";

      sign.forEach(signLineText => {
        let signLineElement = document.createElement("pre");
        signLineElement.className = "signLine";
        signLineElement.innerText = signLineText;
        signElement.appendChild(signLineElement);
      });

      let copyButton = document.createElement("button");
      copyButton.innerText = "复制 Copy";
      copyButton.addEventListener("click", () => {
        try {
          copyToClipboard(sign.join("\n"));
          copyButton.innerText = "已复制 Copied";
        } catch (err) {
          window.alert("复制失败: " + err);
        }
      });
      signElement.appendChild(copyButton);

      wrapper.appendChild(signElement);
    });
  }

  function copyToClipboard(text) {
    const clipboard = navigator.clipboard;
    if (clipboard) {
      clipboard.writeText(text).catch(() => {
        execCommandCopyToClipboard();
      });
    }
    else {
      execCommandCopyToClipboard();
    }

    function execCommandCopyToClipboard() {
      let textArea = document.createElement("textArea");
      // textArea.style.display = "none";
      textArea.style.position = "fixed";
      textArea.setAttribute("readonly", "readonly");
      textArea.value = text;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand("Copy");
      textArea.remove();
    }
  }
</script>

<style>
  @font-face {
    font-family: "Chill Bitmap 7px";
    src: url("ChillBitmap7x.woff2") format("woff2");
  }

  body,
  button,
  #customCharWrapper>label>input {
    font-size: large;
    line-height: 2;
  }

  body {
    width: 100vmin;
    max-width: 100%;
    /* justify-self: center; */

    display: flex;
    flex-direction: column;
    row-gap: 1em;
  }

  h1 {
    font-weight: unset;
    line-height: normal;
    margin: unset;
  }

  .autoWidth {
    width: 100vmin;
    max-width: 100%;
    border-radius: 2px;
    padding: 8px;
    box-sizing: border-box;
  }

  #inputWrapper {
    display: flex;
    flex-direction: column;
  }

  #inputWrapper textarea {
    font-size: 2em;
    font-family: "Chill Bitmap 7px";
    resize: vertical;
  }

  #configWrapper {
    display: flex;
    flex-direction: column;
    row-gap: 1em;
    padding-top: 1em;
    padding-bottom: 1em;
    background-color: #fafafa;
    border: 1px solid #f0f0f0;
    border-radius: 0.5em;
  }

  .signType {
    display: none;
  }

  .signType+img {
    width: 2em;
    height: 2em;
    image-rendering: pixelated;
    border: 1px solid transparent;
    border-radius: 2px;
  }

  .signType:checked+img {
    border: 1px solid #000;
  }

  #customChar {
    display: flex;
    flex-direction: column;
    row-gap: 0.5em;
  }

  #customCharButtons {
    display: flex;
    flex-wrap: wrap;
    row-gap: 0.5em;
    column-gap: 0.5em;
  }

  #customCharWrapper {
    display: flex;
    /* flex-direction: column; */
    flex-wrap: wrap;
    row-gap: 0.5em;
    column-gap: 1em;
    font-family: monospace;
  }

  #customCharWrapper input {
    width: 4em;
  }

  .previewCanvas {
    height: 3em;
    border: 1px solid #ccc;
    image-rendering: pixelated;
  }

  .signLine {
    line-height: 2.25em;
    font-size: 1.5em;
    margin: 0;
    -webkit-user-select: all;
    user-select: all;
    border: 0.5px dashed #ccc;
    text-align: center;
  }

  .sign {
    border: 1px solid #ccc;
    margin-right: 3px;
    display: inline-block;
  }
</style>

</html>